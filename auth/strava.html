<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Strava Authorization - GPX POI Finder</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #FC4C02 0%, #FF6B35 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      color: white;
    }
    .container {
      text-align: center;
      background: rgba(255,255,255,0.15);
      padding: 50px;
      border-radius: 30px;
      backdrop-filter: blur(15px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      max-width: 500px;
    }
    .spinner {
      border: 5px solid rgba(255,255,255,0.3);
      border-top: 5px solid white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 25px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .message {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 15px;
    }
    .details {
      font-size: 1rem;
      opacity: 0.9;
      margin-top: 15px;
    }
    .error {
      background: rgba(244, 67, 54, 0.2);
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }
    .code-display {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 0.9rem;
      margin-top: 20px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon" id="icon">‚úÖ</div>
    <div class="message" id="message">Connexion Strava r√©ussie !</div>
    <div class="spinner" id="spinner"></div>
    <p class="details" id="details">Redirection vers l'application...</p>
    <div class="code-display" id="code-display" style="display:none;"></div>
  </div>

  <script>
    console.log('üîµ Strava callback page loaded');
    console.log('URL:', window.location.href);
    
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const error = urlParams.get('error');
    const scope = urlParams.get('scope');

    const iconEl = document.getElementById('icon');
    const messageEl = document.getElementById('message');
    const spinnerEl = document.getElementById('spinner');
    const detailsEl = document.getElementById('details');
    const codeDisplayEl = document.getElementById('code-display');

    console.log('Code:', code);
    console.log('Error:', error);
    console.log('Scope:', scope);

    if (error) {
      // ‚ùå Erreur d'autorisation
      console.error('‚ùå Authorization error:', error);
      iconEl.textContent = '‚ùå';
      iconEl.style.animation = 'none';
      messageEl.textContent = 'Autorisation refus√©e';
      spinnerEl.style.display = 'none';
      detailsEl.innerHTML = `<div class="error">Erreur: ${error}<br>Veuillez r√©essayer depuis l'application.</div>`;

      // üÜï AJOUT : Redirection automatique vers l'app m√™me en cas d'erreur
      setTimeout(() => {
          window.location.href = `gpxpoifinder://auth/strava?error=${error}`;
      }, 1500); // On laisse 1.5s pour que l'utilisateur lise le message
      
    } else if (code) {
      // ‚úÖ Code re√ßu avec succ√®s
      console.log('‚úÖ Code OAuth re√ßu:', code);
      console.log('Scope:', scope);
      
      // Afficher le code (debug)
      codeDisplayEl.textContent = `Code: ${code.substring(0, 30)}...`;
      codeDisplayEl.style.display = 'block';
      
      // OPTION 1: Si popup (Desktop - fen√™tre ouverte depuis l'app)
      if (window.opener && !window.opener.closed) {
        console.log('üì§ Mode popup d√©tect√© - Envoi du code √† la fen√™tre parente...');
        
        try {
          window.opener.postMessage({
            type: 'strava_auth',
            code: code,
            scope: scope
          }, '*');  // ‚ö†Ô∏è En production, remplacer '*' par votre domaine exact
          
          messageEl.textContent = 'Authentification r√©ussie !';
          detailsEl.textContent = 'Fermeture de la fen√™tre...';
          
          console.log('‚úÖ Message envoy√© √† la fen√™tre parente');
          
          setTimeout(() => {
            console.log('üî¥ Fermeture de la popup...');
            window.close();
          }, 2000);
        } catch (e) {
          console.error('‚ùå Erreur lors de l\'envoi du message:', e);
          detailsEl.innerHTML = '<div class="error">Erreur: Impossible de communiquer avec l\'application.</div>';
        }
      } 
      // OPTION 2: Si mobile/standalone (pas de window.opener)
      else {
        console.log('üì± Mode standalone d√©tect√© - Tentative deep link...');
        
        // Android Custom URL Scheme
        const appUrl = `gpxpoifinder://auth/strava?code=${encodeURIComponent(code)}`;
        messageEl.textContent = 'Connexion r√©ussie ! Retour √† l\'application...';
        
        console.log('üîó Tentative deep link:', appUrl);
        
        // üí° On ajoute un petit d√©lai de 800ms
        setTimeout(() => {
            window.location.href = appUrl;
        }, 800);
        
        // Fallback apr√®s 3 secondes si l'app ne s'ouvre pas
        setTimeout(() => {
          console.log('‚ö†Ô∏è Deep link timeout - Affichage des instructions manuelles');
          
          spinnerEl.style.display = 'none';
          detailsEl.innerHTML = `
            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-top: 20px;">
              <p style="margin-bottom: 15px;">Si l'application ne s'ouvre pas automatiquement :</p>
              <button onclick="window.location.href='${appUrl}'" 
                      style="padding: 15px 30px; background: white; color: #FC4C02; border: none; 
                             border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                üöÄ Ouvrir l'application
              </button>
              <p style="margin-top: 15px; font-size: 0.85rem; opacity: 0.8;">
                Ou revenez √† l'application et reconnectez-vous √† Strava.
              </p>
            </div>
          `;
        }, 3000);
      }
      
    } else {
      // ‚ö†Ô∏è Aucun code re√ßu
      console.warn('‚ö†Ô∏è No code or error in URL');
      iconEl.textContent = '‚ö†Ô∏è';
      iconEl.style.animation = 'none';
      messageEl.textContent = 'Aucun code re√ßu';
      spinnerEl.style.display = 'none';
      detailsEl.innerHTML = '<div class="error">Param√®tres manquants dans l\'URL. Veuillez r√©essayer.</div>';
    }
  </script>
</body>
</html>
